---
title: "Spaces"
author: "Analytics Guild"
date: "01/01/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup

Loading libraries and data.

```{r, include=FALSE}
# load library ----
library(tidyverse)

# load data ----
new_member <- read_csv("./discord/raw_data/guild-joins-by-source_010122.csv")
total_member <- read_csv("./discord/raw_data/guild-total-membership_010122.csv")
first_activation <- read_csv("./discord/raw_data/guild-activation_010122.csv")
next_retention <- read_csv("./discord/raw_data/guild-retention_010122.csv")
visit_comm <- read_csv("./discord/raw_data/guild-communicators_010122.csv")
msg_avg <- read_csv("./discord/raw_data/guild-message-activity_010122.csv")
voice_act <- read_csv("./discord/raw_data/guild-voice-activity_010122.csv")

# snapshot data
snapshot_votes <- read_csv("./snapshot/raw_data/snapshot_votes_s2_010122.csv")
```

## Visualize New Members

Data: analytics/s3_data_activity/discord/raw_data

```{r, echo=FALSE}
new_member %>%
    rename(
        vanity = "vanity_joins",
        discovery = "discovery_joins",
        time = "interval_start_timestamp"
    ) %>%
    pivot_longer(cols = discovery:vanity, names_to = "channel", values_to = "count") %>%
    ggplot(aes(x = time, y = count, fill = channel)) +
    geom_bar(position = "stack", stat = "identity") +
    geom_text(aes(label = count), position = position_stack(vjust = 0.5), color = "white") +
    theme(
        legend.position = "bottom",
        legend.background = element_rect(fill = "#65737e"),
        legend.text = element_text(color = "white"),
        legend.title = element_text(color = "white"),
        panel.background = element_rect(fill = "#65737e"),
        panel.grid.major = element_line(color = "#65737e"),
        panel.grid.minor = element_line(color = "#65737e"),
        plot.background = element_rect(fill = "#65737e"),
        axis.text.x = element_text(color = "white"),
        axis.text.y = element_text(color = "white"),
        axis.title.x = element_text(color = "white"),
        axis.title.y = element_text(color = "white"),
        title = element_text(color = "white", face = "bold")
    ) +
    scale_fill_manual(values = c("white", "red", "black")) +
    labs(
        title = "How many new members are joining?",
        subtitle = "Where are they coming from?",
        y = "Joins",
        x = ""
    )
```

## Visualize Total Member

```{r, echo=FALSE}
total_member %>%
    rename(
        time = "interval_start_timestamp",
        total = "total_membership"
    ) %>%
    ggplot(aes(x = time)) +
    geom_line(aes(y = total), color = "red", size = 1.5) +
    theme(
        panel.background = element_rect(fill = "#65737e"),
        panel.grid.major = element_line(color = "#65737e"),
        panel.grid.minor = element_line(color = "#65737e"),
        plot.background = element_rect(fill = "#65737e"),
        axis.text.x = element_text(color = "white"),
        axis.text.y = element_text(color = "white"),
        axis.title.x = element_text(color = "white"),
        axis.title.y = element_text(color = "white"),
        title = element_text(color = "white", face = "bold")
    ) +
    labs(
        title = "Total membership over time",
        y = "",
        x = ""
    )
```

## Visualize First Day Activation

```{r, echo=FALSE}
first_activation %>%
    rename(
        time = "interval_start_timestamp",
        new = "new_members",
        talked = "pct_communicated",
        visited = "pct_opened_channels"
    ) %>%
    ggplot(aes(x = time)) +
    geom_bar(aes(y = new, color = "New members"), stat = "identity", fill = "black") +
    geom_line(aes(y = talked*15, color = "% talked (voice or text)"), size = 1.5) +
    geom_line(aes(y = visited*15, color = "% visited more than 3 channels"), size = 1.5) +
    geom_line(y = 480, color = "orange", size = 0.2) +
    scale_y_continuous(
        name = "New Members",
        sec.axis = sec_axis(trans = ~./1500*100, name = "% Activated")
    ) +
    scale_color_manual(values = c("white", "red", "black")) +
    theme(
        legend.position = "bottom",
        legend.background = element_rect(fill = "#65737e"),
        legend.text = element_text(color = "white"),
        legend.title = element_text(color = "white"),
        panel.background = element_rect(fill = "#65737e"),
        panel.grid.major = element_line(color = "#65737e"),
        panel.grid.minor = element_line(color = "#65737e"),
        plot.background = element_rect(fill = "#65737e"),
        axis.text.x = element_text(color = "white"),
        axis.text.y = element_text(color = "white"),
        axis.title.x = element_text(color = "white"),
        axis.title.y = element_text(color = "white"),
        title = element_text(color = "white", face = "bold")
    ) +
    labs(
        title = "How many new members successfully activate on their first day?",
        x = "",
        color = "Legend"
    )
```



## Visualize Next Week Retention

```{r, echo=FALSE}
next_retention %>%
    rename(
        time = "interval_start_timestamp",
        new = "new_members",
        retained = "pct_retained"
    ) %>%
    ggplot(aes(x = time)) +
    geom_bar(aes(y = new, color = "New members"), stat = "identity", fill = "black") +
    geom_line(aes(y = retained*15, color = "Week 1 retention"), size = 1.5) +
    geom_line(y = 320, color = "orange", size = 0.2) +
    scale_y_continuous(
        name = "New Members",
        sec.axis = sec_axis(trans = ~./1500*100, name = "Week 1 retention")
    ) +
    scale_color_manual(values = c("black", "red")) +
    theme(
        legend.position = "bottom",
        legend.background = element_rect(fill = "#65737e"),
        legend.text = element_text(color = "white"),
        legend.title = element_text(color = "white"),
        panel.background = element_rect(fill = "#65737e"),
        panel.grid.major = element_line(color = "#65737e"),
        panel.grid.minor = element_line(color = "#65737e"),
        plot.background = element_rect(fill = "#65737e"),
        axis.text.x = element_text(color = "white"),
        axis.text.y = element_text(color = "white"),
        axis.title.x = element_text(color = "white"),
        axis.title.y = element_text(color = "white"),
        title = element_text(color = "white", face = "bold")
    ) +
    labs(
        title = "How many new members retain the next week?",
        x = "",
        color = "Legend"
    )
```

## Visualize Visitors & Communicators

```{r, echo=FALSE}
visit_comm %>%
    rename(
        time = "interval_start_timestamp",
        comm = "pct_communicated"
    ) %>%
    ggplot(aes(x = time)) +
    geom_bar(aes(y = visitors, color = "Visitors"), stat = "identity", fill = "black") +
    geom_line(aes(y = comm*30, color = "% communicators"), size = 1.5) +
    geom_line(y = 1200, color = "orange", size = 0.2) +
    scale_y_continuous(
        name = "Visitors",
        sec.axis = sec_axis(trans = ~./3000*100, name = "% Communicators")
    ) +
    scale_color_manual(values = c("red", "black")) +
    theme(
        legend.position = "bottom",
        legend.background = element_rect(fill = "#65737e"),
        legend.text = element_text(color = "white"),
        legend.title = element_text(color = "white"),
        panel.background = element_rect(fill = "#65737e"),
        panel.grid.major = element_line(color = "#65737e"),
        panel.grid.minor = element_line(color = "#65737e"),
        plot.background = element_rect(fill = "#65737e"),
        axis.text.x = element_text(color = "white"),
        axis.text.y = element_text(color = "white"),
        axis.title.x = element_text(color = "white"),
        axis.title.y = element_text(color = "white"),
        title = element_text(color = "white", face = "bold")
    ) +
    labs(
        title = "How many members visited and communicated?",
        x = "",
        color = "Legend"
    )
```

## Visualize Message - Avg Messages

```{r, echo=FALSE}
msg_avg %>%
    rename(
        time = "interval_start_timestamp",
        per = "messages_per_communicator"
    ) %>%
    ggplot(aes(x = time)) +
    geom_bar(aes(y = messages, color = "Messages sent"), stat = "identity", fill = "black") +
    # conversion between two y-axis (similar to % conversion)
    geom_line(aes(y = per*6000/12, color = "Messages per communicator"), size = 1.5) +
    geom_line(y = 5000, color = "orange", size = 0.2) +
    scale_y_continuous(
        name = "Messages sent",
        sec.axis = sec_axis(trans = ~./6000*12, name = "Message per ommunicator")
    ) +
    scale_color_manual(values = c("red", "black")) +
    theme(
        legend.position = "bottom",
        legend.background = element_rect(fill = "#65737e"),
        legend.text = element_text(color = "white"),
        legend.title = element_text(color = "white"),
        panel.background = element_rect(fill = "#65737e"),
        panel.grid.major = element_line(color = "#65737e"),
        panel.grid.minor = element_line(color = "#65737e"),
        plot.background = element_rect(fill = "#65737e"),
        axis.text.x = element_text(color = "white"),
        axis.text.y = element_text(color = "white"),
        axis.title.x = element_text(color = "white"),
        axis.title.y = element_text(color = "white"),
        title = element_text(color = "white", face = "bold")
    ) +
    labs(
        title = "Message Activity",
        x = "",
        color = "Legend"
    )
```

## Visualize Voice Activity

```{r, echo=FALSE}
voice_act %>%
    rename(
        time = "interval_start_timestamp",
        speak = "speaking_minutes"
    ) %>%
    ggplot(aes(x = time)) +
    geom_bar(aes(y = speak), stat = "identity", fill = "white") +
    theme(
        panel.background = element_rect(fill = "#65737e"),
        panel.grid.major = element_line(color = "#65737e"),
        panel.grid.minor = element_line(color = "#65737e"),
        plot.background = element_rect(fill = "#65737e"),
        axis.text.x = element_text(color = "white"),
        axis.text.y = element_text(color = "white"),
        axis.title.x = element_text(color = "white"),
        axis.title.y = element_text(color = "white"),
        title = element_text(color = "white", face = "bold")
    ) +
    labs(
        title = "Voice Activity",
        subtitle = "Speaking minutes",
        y = "Values",
        x = ""
    )
```

## Visualize Snapshot Votes

Data: analytics/s3_data_activity/snapshot/raw_data

```{r, echo=FALSE}
# snapshot data
snapshot_votes <- read_csv("./snapshot/raw_data/snapshot_votes_s2_010122.csv")


snapshot_votes %>%
    group_by(proposal_id, title) %>%
    tally(sort = TRUE)

```

## Example Sankey

```{r, echo=FALSE}
library(tidyverse)
library(networkD3)

# sample sankey ----

# flow
links <- data.frame(
    source=c("group_A","group_A", "group_B", "group_C", "group_C", "group_E"), 
    target=c("group_C","group_D", "group_E", "group_F", "group_G", "group_H"), 
    value=c(2,3, 2, 3, 1, 3)
)

# nodes
nodes <- data.frame(
    name=c(as.character(links$source), 
           as.character(links$target)) %>% unique()
)

# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# Make the Network
p <- sankeyNetwork(Links = links, Nodes = nodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name", 
              sinksRight=FALSE)
p

```

## Grants Committee Season 1 Sankey

Workflow

Step 1: Replace `NA` values. Note: `NA` values step from having new projects, guilds pop up after the creation of `bankless_wallet_entity` table in DaoDash, so be sure to update that table before proceeding. 

Step 2: =create a `my_links` table, 
Step 2a: a `my_nodes` table, 
Step 2b: create IDSource, IDTarget columns
Step 2c: create `my_color` object.

Step 3: Create sankey w/ SankeyNetwork() function and library.

```{r, echo=FALSE}
library(tidyverse)
library(networkD3)

# load data 
gcs1 <- read_csv("./sankey/raw_data/gc_s1_fund_flow_20220103T044120.csv")

# Alternative way to replace NA values - this works
gcs1$human_readable[is.na(gcs1$human_readable)] <- "Individual Contributor"

my_links <- gcs1 %>%
    select(readable, human_readable, amount_display) %>%
    rename(
        source = readable,
        target = human_readable,
        value = amount_display
    )


my_nodes <- data.frame(name = c("Grants Committee",
                                "Individual Contributor",
                                "DAO Punks",
                                "BizDev Guild",
                                "A/V Guild",
                                "BED Index",
                                "First Quest",
                                "Degen",
                                "Marketing Guild",
                                "BountyBoard",
                                "Bankless Academy",
                                "Bankless Website Multisig",
                                "Liquity Project Multisig",
                                "Bankless Loans",
                                "Research Guild",
                                "Analytics Guild",
                                "Design Guild",
                                "Ops Guild",
                                "Writers Guild",
                                "Treasury Guild",
                                "Translators Guild",
                                "Devs Guild Multisig",
                                "Legal Guild"))


# create id for each node ----
# links$IDsource <- match(links$source, nodes$name)-1 
# links$IDtarget <- match(links$target, nodes$name)-1

my_links$IDsource <- match(my_links$source, my_nodes$name)-1
my_links$IDtarget <- match(my_links$target, my_nodes$name)-1

# set color -- swap : #006d2c
my_color <- 'd3.scaleOrdinal() .domain(["Grants Committee", 
                                        "Individual Contributor", 
                                        "DAO Punks", 
                                        "BizDev Guild", 
                                        "A/V Guild", 
                                        "BED Index",
                                        "First Quest",
                                        "Degen",
                                        "Marketing Guild",
                                        "BountyBoard",
                                        "Bankless Academy",
                                        "Bankless Website Multisig",
                                        "Liquity Project Multisig",
                                        "Bankless Loans",
                                        "Research Guild",
                                        "Analytics Guild",
                                        "Design Guild",
                                        "Ops Guild",
                                        "Writers Guild",
                                        "Treasury Guild",
                                        "Translators Guild",
                                        "Devs Guild Multisig",
                                        "Legal Guild"]) .range(["red", 
                                                                "#2ca25f", 
                                                                "#66c2a4", 
                                                                "#b2e2e2", 
                                                                "#edf8fb", 
                                                                "#8B8989",
                                                                "#006d2c", 
                                                                "#2ca25f", 
                                                                "#66c2a4", 
                                                                "#b2e2e2", 
                                                                "#edf8fb", 
                                                                "#8B8989",
                                                                "#006d2c", 
                                                                "#2ca25f", 
                                                                "#66c2a4", 
                                                                "#b2e2e2", 
                                                                "#edf8fb", 
                                                                "#8B8989",
                                                                "#006d2c", 
                                                                "#2ca25f", 
                                                                "#66c2a4", 
                                                                "#b2e2e2", 
                                                                "#edf8fb"])'


sankeyNetwork(Links = my_links, Nodes = my_nodes, Source = "IDsource",
              Target = "IDtarget", Value = "value", NodeID = "name",
              colourScale = my_color, fontSize = 15, sinksRight=FALSE)

```


## Grants Committee Season 2 Sankey

NOTE: Need to consult this [sheet](https://docs.google.com/spreadsheets/d/1a6ZMclYkESWNwV7xNhT-LELwHtK28wo9f4xx-JGab5k/edit#gid=0) to add additional project, guild multisig & address to `bankless_wallet_entity` table in DAODash.

```{r, echo=FALSE}
library(tidyverse)
library(networkD3)

# load data
gcs2 <- read_csv("./sankey/raw_data/gc_s2_fund_flow_20220105T074303.csv")

# create id for each node
# Alternative way to replace NA values - this works
gcs2$human_readable[is.na(gcs2$human_readable)] <- "Individual Contributor & Others"


# create links
my_links_2 <- gcs2 %>%
    select(readable, human_readable, amount_display) %>%
    rename(
        source = readable,
        target = human_readable,
        value = amount_display
    )

# create nodes
# note: unique() function doesn't capture "Grants Committee" so that has to be entered manually
my_nodes_2 <- unique(my_links_2[c("target")])

my_nodes_2[14,] <- "Grants Committee"

# change column name from 'target' -> 'name'
my_nodes_2 <- my_nodes_2 %>%
    rename(name = target)

# create id for each node ----
# links$IDsource <- match(links$source, nodes$name)-1 
# links$IDtarget <- match(links$target, nodes$name)-1

my_links_2$IDsource <- match(my_links_2$source, my_nodes_2$name)-1
my_links_2$IDtarget <- match(my_links_2$target, my_nodes_2$name)-1

# add color
my_color_2 <- 'd3.scaleOrdinal() .domain(["Grants Committee", 
                                        "Individual Contributor & Others", 
                                        "Crypto Sapiens",
                                        "DAO Punks", 
                                        "S1 Coordinape",     
                                        "A/V Guild",
                                        "FightClub",
                                        "Content Gateway",
                                        "Marketing Guild",    
                                        "BountyBoard",       
                                        "Writers Guild",       
                                        "Translators Guild",   
                                        "DaoDash",
                                        "Legal Guild"]) .range(["red", 
                                                                "#2ca25f", 
                                                                "#66c2a4", 
                                                                "#b2e2e2", 
                                                                "#edf8fb", 
                                                                "#8B8989",
                                                                "#006d2c", 
                                                                "#2ca25f", 
                                                                "#66c2a4", 
                                                                "#b2e2e2", 
                                                                "#edf8fb", 
                                                                "#8B8989",
                                                                "red", 
                                                                "red"])'


# sankey
sankeyNetwork(Links = my_links_2, Nodes = my_nodes_2, Source = "IDsource",
              Target = "IDtarget", Value = "value", NodeID = "name", 
              colourScale = my_color_2, fontSize = 15, sinksRight=FALSE)


```


## Number of Bank Holders (Membership Categories); S1 vs S2

**Task**: Compare S1 vs S2 on all membership categories.

**Challenge**: Data is secured, need to visualize. 

See `mem_1_10K_bank_holdings_time_range` and other segments downloaded in raw csv. 
Data gathered from DAODash table: 

```{r, echo=FALSE}

library(lubridate)

bank_sg <- read_csv("./bank_subgraph/raw_data/mem_1_10K_bank_holdings_time_range_20220102T062946.csv")

# turn time stamp into date
bank_sg %>%
    mutate(
        new_day = date(day)
    ) %>%
    group_by(new_day) %>%
    tally(sort = TRUE) %>%
    arrange(new_day) %>%
    mutate(
        cummulative = cumsum(n)
    )%>%
    ggplot(aes(x = new_day, y = cummulative)) +
    geom_line() +
    scale_x_date(date_breaks = "1 month") +
    labs(
        title = "Number of BANK Holders overtime"
    )

```


## Coordinape Distribution

**Task**: Query comparison of tokens/bank distributed via Coordinape in S1 vs S2.

**Challenge**: See DaoDash query. 

```{r, echo=FALSE}

```

## POAP Distribution

**Task**: Find number of POAPs claimed for Community Calls S1 vs S2

**Progress**: Query Content Gateway API endpoint: 

https://prod-content-gateway-api.herokuapp.com/api/v1/graphql

Query historical -> PoapV1 -> PoapTokenV1s

Can query all events containing "Bankless DAO Community" (for community call poaps), but still need to find *number of poaps* claimed at each event. 


```{r, echo=FALSE}
# GraphiQL query
# {
#  historical{
#    PoapV1 {
#      PoapEventV1s(first: 200, where: {name: {contains: "Bankless DAO Community"}}){
#        data{
#          id,
#          fancyId,
#          name,
#          year,
#          eventHostId,
#          eventTemplateId,
#          eventUrl
#        }
#      }
#    }
#  }
#}




```

## Bounty Board

**Task**: Query total number of bounties and total value committed to bounties between S1 v S2.

**Challenge**: query from database in prod. WIP. 

```{r, echo=FALSE}

```

## Discourse

Task: Connect to API to query forum posts with polls and number of people voting.

Challenge: API documentation does not mention Polls or Votes. See [documentation](https://docs.discourse.org/) here. 

```{r, echo=FALSE}

```


## First Quest

Task: Query number of new members going through First Quest 

**Challenge**: Data inserted at 2021-11-18, might have insufficient data to make S1 vs S2 comparison.

```{r, echo=FALSE}

```


## Tips Given & Received

**Task**: Get comparison between S1 and S2

**Challenge**: Insufficient tipping data that goes back to S1 ?

```{r, echo=FALSE}

```

## Next Section

```{r, echo=FALSE}

```


## Next Section

```{r, echo=FALSE}

```


